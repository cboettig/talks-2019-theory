---
author: "Carl Boettiger"
institute: "UC Berkeley"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["default", "solarized-light.css"]
    lib_dir: libs
    seal: false
    nature:
      highlightStyle: "solarized-light"
      highlightLines: true
      countIncrementalSlides: false
      slideNumberFormat: "%current%"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(#dev.args=list(bg="transparent"), 
                      echo = FALSE, 
                      message=FALSE, 
                      warning=FALSE,
                      fig.width=10,
                      fig.height = 5,
                      cache = 1)

library(tidyverse)
library(ggthemes)
library(magick)
theme_set(theme_solarized(base_size=26))
scale_colour_discrete <- function(...) scale_colour_solarized()
scale_fill_discrete <- function(...) scale_fill_solarized()
pal <- solarized_pal()(3)

txtcolor <- "#586e75"
```

layout: true
background-color: #fdf6e3
class: center, top

---

# Theory of uncertainty, ecological variation, and the limits of prediction


<div class="my-footer">

<a href="https://carlboettiger.info"> `r icon::fa("user")` Carl Boettiger</a> | 
<a href="https://berkeley.edu"> `r icon::fa("briefcase")` UC Berkeley</a> | 
<a href="https://twitter.com/cboettig"> `r icon::fa("twitter")` @cboettig</a>

</div>

---

# Noise the Nusiance

# Stochastic Phenomena

# Noise as Information

# Decisions Under Uncertainty

---



---
layout: false
background-image: url(../image-library/royalsociety/pensive-polarbear.jpg)
background-position: center
background-size: 130%
class: center, top

---

# What is "noise" anyway?

.pull-left[

## Stochasticity

### Demographic / intrinsic
### Environmental / extrinisic
### Individual heterogeneity

]

.pull-right[ 
## Model uncertainty

### Parameter uncertainty
### Structural uncertainty

]

## Measurement uncertainty

---

layout: true
background-color: #fdf6e3
class: center, top


---

# *Noise the Nusiance*

# Stochastic Phenomena

# Noise as Information

# Decisions Under Uncertainty


---

# The canonical model

\begin{equation}
\textrm{d} N_t = \underbrace{f(N_t) \textrm{d} t}_{\textrm{det skeleton}} + \underbrace{\sigma_d \sqrt{N_t} \phantom{\cdot}\textrm{d}B_t^{(d)} }_{\textrm{demographic noise}} + \underbrace{\sigma_e N_t \phantom{\cdot}\textrm{d}B_t^{(e)}}_{\textrm{environmental noise}} 
\label{canonical}
\end{equation}

- (e.g. Lande et al 1993)
- rough jusification in Kurtz 1970, 1973, 1978
- Deterministic skeleton -> expected dynamics


---


# Noise the Nusiance

# *Stochastic Phenomena*

# Noise as Information

# Decisions despite Uncertainty

---

# Stochastic Phenomena: Quasi-cycles

```{r }
read_csv("data/quasicycles.csv") %>%
  gather(species, population, -t, -sigma) %>%
  mutate(sigma = as.factor(sigma)) %>%
  mutate(sigma = recode(sigma, "1e-05" = "A.", "0.01" = "B.")) %>%
  rename(time = t) %>%
  ggplot(aes(time, population, col = species)) +
  geom_line() + 
  facet_wrap(~ sigma, ncol=2) + 
  scale_color_solarized() +
  theme(legend.position = "none")
```


---

# Stochastic Phenomena: Quasi-cycles
```{r}
img <- image_read("img/resonance-bjornstad2004.png") %>% image_transparent("white")

ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf) + 
  labs(title="Bluefin tuna stocks, Bjornstad et al. 2004")

```

---

# Stochastic Phenomena: Noisy switch


$$X_{t+1} = X_t + \underbrace{X_t r \left(1 -\frac{X_t}{K} \right)}_{\textrm{ growth, } g(X_t)}  - \underbrace{\frac{a X_t ^ Q}{X_t^ Q + H ^ Q}}_{\textrm{consumption, } c(X_t)} + \xi_t,$$

```{r noisy_switch}
p <- list(r = .5, K = 2, Q = 5, H = .38, sigma = .04, a = 0.245, N = 1e4)
theory <- tibble(x = seq(0,2, length.out = 100)) %>%
  mutate(growth = x * p$r * (1 - x / p$K), 
         consumption = p$a * x ^ p$Q / (x^p$Q + p$H^p$Q)) %>%
  mutate(potential = - cumsum(growth - consumption)) %>%
  gather(curve, y, -x, -potential) 

theory %>%
  ggplot(aes(x, y, col=curve)) +
  geom_line(lwd = 2) + 
  labs(x = bquote(X[t]), y = bquote(X[t+1])) 
```

---

# Stochastic Phenomena: Noisy switch


$$X_{t+1} = X_t + \underbrace{X_t r \left(1 -\frac{X_t}{K} \right)}_{\textrm{ growth, } g(X_t)}  - \underbrace{\frac{a X_t ^ Q}{X_t^ Q + H ^ Q}}_{\textrm{consumption, } c(X_t)} + \xi_t,$$ÃŸ

```{r}
theory %>%
  ggplot(aes(x, potential)) + 
  geom_line(col=pal[1], lwd=2) + 
  coord_cartesian(xlim=c(0,1.6), ylim=c(-1.15,-0.9)) + 
  ggtitle("Potential Well diagram")

```



---

# Stochastic Phenomena: Noisy switch


```{r}
read_csv("data/noisy_switch.csv")  %>%
  ggplot(aes(t,x)) + 
  geom_line(col = pal[[1]]) 
```


---

```{r}
img <- image_read("img/switching-keeling2001.png") %>%
  image_transparent("white")
ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, 
                    ymin=-Inf, ymax=Inf)
```

Data on prevelance of rubella in Copenhagen illustrating potential stochastic 
switching dynamics between two regimes, reproduced from Keeling et al 2001




---


# Noise the Nusiance

# Stochastic Phenomena

# *Noise as Information*

# Decisions Under Uncertainty


---


# Knowledge from Noise?

## Early Warning Signals



```{r}
tipping <- read_csv("data/tipping.csv") 
scientific <- function(l) {
    if(max(l, na.rm=TRUE) < 1e3) return(l)
     l <- format(l, scientific = TRUE)
     l <- gsub("^(.*)e", "'\\1'e", l)
     l <- gsub("e", "%*%10^", l)
     l <- gsub("^'1'%\\*%", "", l)
     l <- gsub("\\+", "", l)
     parse(text=l)
}
tipping %>% 
  select(t, population = x, tip_time) %>%
  ggplot(aes(t, population)) +
  geom_line(lwd = 1, col = pal[1]) + 
  geom_vline(aes(xintercept = tip_time), lwd = 1, col = pal[2], lty=2) + 
  scale_y_log10(labels=scientific)  + 
  coord_cartesian(ylim=c(1e3, 5e5)) +
  labs(subtitle = "Yeast population size", 
       caption = "Vertical red dashed line indicates tipping point location")
```

---

```{r}
tipping %>%
  dplyr::select(-x) %>%
  dplyr::rename("autocorrelation" = autocorrelation, "variance" = variance) %>%
  gather(series, value, -t, -tip_time) %>%
  ggplot(aes(t, value)) + 
  geom_line(lwd = 1, col = pal[[1]]) + 
  geom_vline(aes(xintercept = tip_time), lwd = 1, col = pal[[2]], lty=2) +
  facet_wrap(~series, ncol = 2, scales="free_y") 
```

---

## Tipping points: empirical examples

Dai et al (2015)

```{r}
img <- image_read("img/pop-dai2015.png") %>% image_transparent("white")
ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
```

---

## Tipping points: empirical examples


```{r}
img <- image_read("img/cv-dai2015.png") %>%
  image_transparent("white")

ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
```

---


# Noise the Nusiance

# Stochastic Phenomena

# Noise as Information

# *Decisions Under Uncertainty*


---

## Decisions Under Uncertainty: does it matter?

.pull-left[

```{r}
img <- image_read("img/noaa_tuna_net.jpg")
ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
```
] 

.pull-right[

```{r}
img <- image_read("img/Reed.png") %>% image_transparent("white")
ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
```

-- Reed 1979
]


---

## Paradox of Measurement Uncertainty


```{r}
img <- image_read("img/Clark.png")%>% image_transparent("white")
ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
```

Clark & Kirkwood, 1987

---

## Paradox of Measurement Uncertainty


```{r}
img <- image_read("img/Sethi.png")%>% image_transparent("white")
ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
```


---

```{r}
policies_w_priors <- vroom::vroom("data/policies_w_priors.csv")

policies_w_priors %>% select(-harvest) %>%
  gather(panel, value, -state, -policy) %>%
  rename(method = policy) %>%
  ggplot(aes(state, value, col=method)) + 
  geom_line(lwd=3, alpha = 0.9)  +
  facet_wrap(~panel, ncol=2, scales = "free_y") +
  xlab("observed stock size") +
  ylab("policy") +
  theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0,1), ylim = c(0,.8)) 
```


---


```{r}
vroom::vroom("data/pomdp_sims.csv", col_types = "inicnnn")  %>%
  select(-value) %>%
  #filter(method != "MSY") %>%
  filter(sigma_g %in% c("0.02", "0.15")) %>%
  filter(sigma_m %in% c("0", "0.15")) %>%
  group_by(time, method, sigma_m, sigma_g) %>%
  summarise(mean = mean(state), sd = sd(state)) %>% 
  ungroup()  %>% 
  mutate(sigma_m = as.character(sigma_m), 
         sigma_g = as.character(sigma_g)) %>%
  mutate(ymax = mean + sd, ymin = pmax(mean - sd, 0)) %>%
  
  ggplot(aes(time, mean, col = method, fill = method)) + 
  geom_line(lwd=2.5) + 
  geom_ribbon(aes(ymax = ymax, ymin = ymin), col = NA, alpha = 0.1) +
  facet_grid(sigma_g ~ sigma_m, 
             labeller = label_bquote(rows = sigma[g] == .(sigma_g),
                                     cols = sigma[m] == .(sigma_m),
                                     )) + 
  coord_cartesian(ylim = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  ylab("Mean biomass")
```


---

# Opportunities and Pitfalls


Relaxing structural assumptions of the model (GP, neural net, etc)



---


Notes:

> Epistemic uncertainty limits our ability to describe, understand, predict, and manage the spatio-temporal dynamics of ecological systems.  Crucially, complex distributions underlie ecological processes at all levels of organization.  Why and how does variation arise and propagate (in space, time, among individuals) and how much variation do we expect? A deeper understanding of ecological variation will help to identify the limits and the uncertainties of ecological predictions.  How can information theoretic approaches be used effectively to glean knowledge from noisy and limited data?


