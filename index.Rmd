---
author: "Carl Boettiger"
institute: "UC Berkeley"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["default", "solarized-light.css"]
    lib_dir: libs
    seal: false
    nature:
      highlightStyle: "solarized-light"
      highlightLines: true
      countIncrementalSlides: false
      slideNumberFormat: "%current%"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(#dev.args=list(bg="transparent"), 
                      echo = FALSE, 
                      message=FALSE, 
                      warning=FALSE,
                      fig.width=10,
                      fig.height = 5,
                      cache = 1)

library(tidyverse)
library(ggthemes)
library(magick)
theme_set(theme_solarized(base_size=26))
scale_colour_discrete <- function(...) scale_colour_solarized()
scale_fill_discrete <- function(...) scale_fill_solarized()
pal <- solarized_pal()(3)

txtcolor <- "#586e75"
```

layout: true
background-color: #fdf6e3
class: center, top

---
class: middle

# Theory of uncertainty, ecological variation, and the limits of prediction


<div class="my-footer">

<a href="https://carlboettiger.info"> `r icon::fa("user")` Carl Boettiger</a> | 
<a href="https://berkeley.edu"> `r icon::fa("briefcase")` UC Berkeley</a> | 
<a href="https://twitter.com/cboettig"> `r icon::fa("twitter")` @cboettig</a>

</div>


---
layout: false
background-image: url(../image-library/royalsociety/pensive-polarbear.jpg)
background-position: center
background-size: 130%
class: center, top

---
layout: true
background-color: #fdf6e3
class: center, top

---

# What is "noise" anyway?

.pull-left[

## Stochasticity

### Demographic / intrinsic
### Environmental / extrinisic
### Individual heterogeneity

]

.pull-right[ 
## Model uncertainty

### Parameter uncertainty
### Structural uncertainty

]

## Measurement uncertainty

---

# *Noise the Nusiance*

# Stochastic Phenomena

# Noise as Information

# Decisions Under Uncertainty

# Limits of Prediction

---

# The canonical model

\begin{equation}
\textrm{d} N_t = \underbrace{f(N_t) \textrm{d} t}_{\textrm{det skeleton}} + \underbrace{\sigma_d \sqrt{N_t} \phantom{\cdot}\textrm{d}B_t^{(d)} }_{\textrm{demographic noise}} + \underbrace{\sigma_e N_t \phantom{\cdot}\textrm{d}B_t^{(e)}}_{\textrm{environmental noise}} 
\label{canonical}
\end{equation}

- (e.g. Lande 1993, Foley 1994, etc)
- rough jusification in Kurtz 1970, 1973, 1978
- Deterministic skeleton -> expected dynamics


---


# Noise the Nusiance

# *Stochastic Phenomena*

# Noise as Information

# Decisions despite Uncertainty

# Limits of Prediction

---

# Stochastic Phenomena: Quasi-cycles

```{r quasicycles}
read_csv("data/quasicycles.csv") %>%
  gather(species, population, -t, -sigma) %>%
  mutate(sigma = as.factor(sigma)) %>%
  mutate(sigma = recode(sigma, "1e-05" = "A.", "0.01" = "B.")) %>%
  rename(time = t) %>%
  ggplot(aes(time, population, col = species)) +
  geom_line() + 
  facet_wrap(~ sigma, ncol=2) + 
  scale_color_solarized() +
  theme(legend.position = "none")
```
Nisbet & Gurney 1976

---

# Stochastic Phenomena: Quasi-cycles
```{r bjornstad2004}
img <- image_read("../image-library/published/resonance-bjornstad2004.png") %>% image_transparent("white")

ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf) + 
  labs(title="Bluefin tuna stocks, Bjornstad et al. 2004")

```

---

# Stochastic Phenomena: Noisy switch


$$X_{t+1} = X_t + \underbrace{X_t r \left(1 -\frac{X_t}{K} \right)}_{\textrm{ growth, } g(X_t)}  - \underbrace{\frac{a X_t ^ Q}{X_t^ Q + H ^ Q}}_{\textrm{consumption, } c(X_t)} + \xi_t,$$

```{r noisy_switchA}
p <- list(r = .5, K = 2, Q = 5, H = .38, sigma = .04, a = 0.245, N = 1e4)
theory <- tibble(x = seq(0,2, length.out = 100)) %>%
  mutate(growth = x * p$r * (1 - x / p$K), 
         consumption = p$a * x ^ p$Q / (x^p$Q + p$H^p$Q)) %>%
  mutate(potential = - cumsum(growth - consumption)) %>%
  gather(curve, y, -x, -potential) 

theory %>%
  ggplot(aes(x, y, col=curve)) +
  geom_line(lwd = 2) + 
  labs(x = bquote(X[t]), y = bquote(X[t+1])) 
```

May 1977

---

# Stochastic Phenomena: Noisy switch


$$X_{t+1} = X_t + \underbrace{X_t r \left(1 -\frac{X_t}{K} \right)}_{\textrm{ growth, } g(X_t)}  - \underbrace{\frac{a X_t ^ Q}{X_t^ Q + H ^ Q}}_{\textrm{consumption, } c(X_t)} + \xi_t,$$ß

```{r potential}
theory %>%
  ggplot(aes(x, potential)) + 
  geom_line(col=pal[1], lwd=2) + 
  coord_cartesian(xlim=c(0,1.6), ylim=c(-1.15,-0.9)) + 
  ggtitle("Potential Well diagram")

```



---

# Stochastic Phenomena: Noisy switch


```{r noisy_switch}
read_csv("data/noisy_switch.csv")  %>%
  ggplot(aes(t,x)) + 
  geom_line(col = pal[[1]]) 
```


---

```{r keeling2001}
img <- image_read("../image-library/published/switching-keeling2001.png") %>%
  image_transparent("white")
ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, 
                    ymin=-Inf, ymax=Inf)
```

Rubella prevelance in Copenhagen illustrating potential stochastic 
switching dynamics between two regimes, reproduced from Keeling et al 2001




---


# Noise the Nusiance

# Stochastic Phenomena

# *Noise as Information*

# Decisions Under Uncertainty

# Limits of Prediction

---

# Knowledge from Noise?

## Mechanistic understanding

.pull-left[

Levins 1969

$$\frac{d n}{d t} = \underbrace{c n \left(1 - \frac{n}{N}\right)}_{\textrm{birth}} - \underbrace{e n}_{\textrm{death}}$$
Logistic 

$$\frac{d n}{d t} = \underbrace{c n}_{\textrm{birth}} \underbrace{\left(1 - \frac{n}{N}\right)}_{\textrm{death}}$$

]
.pull-right[
$$\sigma^2 = \frac{b(n) + d(n)}{2 \partial_n b(n) - 2\partial_n d(n)}$$
]

--

Levins: \sigma^2 = N\frac{e}{c}$, Logistic: $\sigma^2 = K$

---



# Knowledge from Noise?

## Early Warning Signals



```{r dai_sim}
tipping <- read_csv("data/tipping.csv") 
scientific <- function(l) {
    if(max(l, na.rm=TRUE) < 1e3) return(l)
     l <- format(l, scientific = TRUE)
     l <- gsub("^(.*)e", "'\\1'e", l)
     l <- gsub("e", "%*%10^", l)
     l <- gsub("^'1'%\\*%", "", l)
     l <- gsub("\\+", "", l)
     parse(text=l)
}
tipping %>% 
  select(t, population = x, tip_time) %>%
  ggplot(aes(t, population)) +
  geom_line(lwd = 1, col = pal[1]) + 
  geom_vline(aes(xintercept = tip_time), lwd = 1, col = pal[2], lty=2) + 
  scale_y_log10(labels=scientific)  + 
  coord_cartesian(ylim=c(1e3, 5e5)) +
  labs(subtitle = "Yeast population size", 
       caption = "Vertical red dashed line indicates tipping point location")
```

---

```{r dai_sim_stats}
tipping %>%
  dplyr::select(-x) %>%
  dplyr::rename("autocorrelation" = autocorrelation, "variance" = variance) %>%
  gather(series, value, -t, -tip_time) %>%
  ggplot(aes(t, value)) + 
  geom_line(lwd = 1, col = pal[[1]]) + 
  geom_vline(aes(xintercept = tip_time), lwd = 1, col = pal[[2]], lty=2) +
  facet_wrap(~series, ncol = 2, scales="free_y") 
```

---

## Tipping points: empirical examples

```{r pop_dai2015}
img <- image_read("../image-library/published/pop-dai2015.png") %>% image_transparent("white")
ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
```

Dai et al (2015)

---

## Tipping points: empirical examples


```{r cv_dai}
img <- image_read("../image-library/published/cv-dai2015.png") %>%
  image_transparent("white")

ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
```

Dai et al (2015)

---

## Critical-speeding up?


\[ dX_t = X_t \frac{r}{\beta} \left( \frac{X_t}{\beta A} -1 \right) \left(1 - \frac{X_t}{\beta C} \right) dt + \sigma dB_t \]

- Carrying capacity $C$, Allee threshold $A$
- available territory $\beta$

```{r watson2019, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
dx <- function(x,  β = .3, r = 1, A = 1.5, C = 2.5){
  x * (r/β) * (x / (β*A)-1)*(1 - x / (β*C))
}
x <- seq(-1,4, length.out = 400)
β <- seq(0.1, 1.2, length.out = 4)
df <- map_dfr(β, 
               function(β) 
                 data.frame(x = x, 
                            dx = dx(x, β=β), 
                            V = -cumsum(dx(x, β=β)),
                            β=β))%>%
  mutate(β=as.factor(round(β, digits=3)))

ggplot(df, aes(x,dx, color = β)) + geom_line(lwd=1) + 
  coord_cartesian(ylim = c(-0.3, .2), xlim = c(0,4)) 
```

[Titus et al (2019)](https://arxiv.org/abs/1901.08084)



---


# Noise the Nusiance

# Stochastic Phenomena

# Noise as Information

# *Decisions Under Uncertainty*

# Limits of Prediction

---
layout: false
background-image: url(../image-library/noaa/noaa_fisheries.jpg)
background-position: center
background-size: 130%
class: center, top

---
layout: true
background-color: #fdf6e3
class: center, top

---

# MSY & Constant Escapement

```{r msy, echo=FALSE, fig.width=8, fig.height=4.5}
r <- 1
K <- 100
H <- 0
logistic <- function(N) r * N * (1 - N / K) - H

data_frame(population_size = 0:100, 
           growth_rate = logistic(population_size)) %>%
  ggplot(aes(population_size, growth_rate)) + 
  geom_path(size=3, col = pal[[1]]) +
  geom_vline(aes(xintercept = K/2), lty = "dashed", size = 2, col = pal[[2]]) +
  xlab("population size") + ylab("growth rate")
 
```


--

$$\frac{dN}{dt} = \underbrace{r N \left(1 - \frac{N}{K} \right)}_{f(N)} - H$$
$$H_{\text{MSY}} = f(N) = r K / 4, \phantom S B_{\text{MSY}} = K/2$$

Schaefer 1954; Clark 1973

---


## Decisions Under Uncertainty: does it matter?


```{r reed1979}
img <- image_read("../image-library/published/reed1979.png") %>% image_transparent("white")
ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
```

Reed 1979



---

## Paradox of Measurement Uncertainty


```{r clark1987}
img <- image_read("../image-library/published/clark1987.png")%>% image_transparent("white")
ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
```

Clark & Kirkwood, 1987

---

## Paradox of Measurement Uncertainty


```{r sethi2005}
img <- image_read("../image-library/published/sethi2005.png")%>% image_transparent("white")
ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
```

Sethi et al (2005)

---

```{r jetstream, fig.height=8}
img <- image_read("../image-library/img/jetstream.jpg")
p1 <- ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
img <- image_read("../image-library/img/self-driving.png")
p2 <- ggplot() + 
  annotation_raster(img, 
                    xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
library(patchwork)
p1 + p2 + plot_layout(ncol = 1)
```




---

```{r pomdp_policies, fig.height=7}
policies_w_priors <- readr::read_csv("data/policies_w_priors.csv")

policies_w_priors %>% select(-harvest) %>%
  gather(panel, value, -state, -policy) %>%
  rename(method = policy) %>%
  ggplot(aes(state, value, col=method)) + 
  geom_line(lwd=3, alpha = 0.9)  +
  facet_wrap(~panel, ncol=2, scales = "free_y") +
  xlab("observed stock size") +
  ylab("policy") +
  theme(legend.position = "bottom") +
  coord_cartesian(xlim = c(0,1), ylim = c(0,.8)) 
```

Memarzadeh & Boettiger (2019)
---


```{r pomdp_sims, fig.height=9}
readr::read_csv("data/pomdp_sims.csv", col_types = "inicnnn")  %>%
  select(-value) %>%
  #filter(method != "MSY") %>%
  filter(sigma_g %in% c("0.02", "0.15")) %>%
  filter(sigma_m %in% c("0", "0.15")) %>%
  group_by(time, method, sigma_m, sigma_g) %>%
  summarise(mean = mean(state), sd = sd(state)) %>% 
  ungroup()  %>% 
  mutate(sigma_m = as.character(sigma_m), 
         sigma_g = as.character(sigma_g)) %>%
  mutate(ymax = mean + sd, ymin = pmax(mean - sd, 0)) %>%
  
  ggplot(aes(time, mean, col = method, fill = method)) + 
  geom_line(lwd=2.5) + 
  geom_ribbon(aes(ymax = ymax, ymin = ymin), col = NA, alpha = 0.1) +
  facet_grid(sigma_g ~ sigma_m, 
             labeller = label_bquote(rows = sigma[g] == .(sigma_g),
                                     cols = sigma[m] == .(sigma_m),
                                     )) + 
  coord_cartesian(ylim = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  ylab("Mean biomass")
```

---

# Noise the Nusiance

# Stochastic Phenomena

# Noise as Information

# Decisions Under Uncertainty

# *Limits of Prediction*
---

# Limits of Prediction

```{r train}
arima_forecast <- readr::read_csv("data/arima_forecast.csv.gz")
train <- arima_forecast %>% filter(t < 2000) 
test <- arima_forecast %>% filter(t > 2000) 
train %>%
  ggplot(aes(t)) + 
  geom_line(aes(y=x)) +
  xlim(0,3000) + ylab("x")
```
---

# Limits of Prediction

```{r arima_predict}
train %>%
  ggplot(aes(t)) + 
  geom_line(aes(y=x)) +
  geom_line(aes(y=pred), lwd = 2, lty = 3, col = pal[2], data = test) + 
  geom_ribbon(aes(y=pred, ymin=pred-se, ymax=pred+se), 
              alpha = 0.4, fill = pal[2], data = test)  + 
  xlim(0,3000) + ylab("x")
```

---

# Limits of Prediction

```{r arima_predict_fail}
train %>%
  ggplot(aes(t)) + 
  geom_line(aes(y=x)) +
  geom_line(aes(y=pred), lwd = 2, lty = 3, col = pal[2], data = test) + 
  geom_ribbon(aes(y=pred, ymin=pred-se, ymax=pred+se), 
              alpha = 0.4, fill = pal[2], data = test)  + 
  geom_line(aes(y=x), data = test, lty = 2, lwd = 2, col=pal[1]) +
  xlim(0,3000) + ylab("x")
```

---

## Perfect information:

```{r true_predict}
model_forecast <- readr::read_csv("data/model_forecast.csv.gz")
model_forecast %>% 
  filter(set == "true") %>%
  ggplot(aes(t,x)) +
  geom_line(aes(group = interaction(reps, set), col = set), alpha = .1) + 
  geom_line(data = train)
```

---

## Perfect knowledge of structure 

(MCMC estimate of parameters)

```{r est_predict}
model_forecast %>% 
  filter(set == "predicted") %>%
  ggplot(aes(t,x)) +
  geom_line(aes(group = interaction(reps, set), col = set), alpha = .3) + 
  geom_line(data = train)
```


